<!-- app/templates/backup_dashboard.html (动态备份管理版) -->

{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">备份状态清单</h1>
</div>
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>系统编号</th>
                        <th>仪器/系统名称</th>
                        <th>系统分组</th>
                        <th>电脑加域</th>
                        <th>备份方式</th>
                        <th>备份频次</th>
                        <th>Avamar备份状态</th>
                        <th>上次备份日期</th>
                        <th>下次备份日期</th>
                        <th>状态</th>
                        {% if current_user.role in ['admin', 'qc'] %}
                        <th>操作</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for system in systems %}
                    <tr>
                        <td>{{ system.system_number }}</td>
                        <td><a href="{{ url_for('routes.system_detail', system_id=system.id) }}">{{ system.name }}</a></td>
                        <td><span class="badge bg-secondary">{{ system.group.name if system.group else '未分组' }}</span></td>
                        <td><span class="badge {{ 'bg-success' if system.is_domain_joined else 'bg-secondary' }}">{{ "是" if system.is_domain_joined else "否" }}</span></td>
                        <td>
                            {% set method = system.backup_method or '未配置' %}
                            {% if '手动' in method %}<span class="badge bg-warning text-dark">{{ method }}</span>
                            {% elif method == 'avamar自动备份' %}<span class="badge bg-success">{{ method }}</span>
                            {% elif method == '无需备份' %}<span class="badge bg-secondary">{{ method }}</span>
                            {% else %}<span class="badge bg-light text-dark">{{ method }}</span>{% endif %}
                        </td>
                        <td>{{ system.backup_frequency or '未配置' }}</td>
                            <td>
                            {% set status = system.avamar_status or '未知' %}
                            {% if 'Succeeded' in status %}
                                <span class="badge bg-success" title="{{ status }}">成功</span>
                            {% elif 'Failed' in status %}
                                <span class="badge bg-danger" title="{{ status }}">失败</span>
                            {% else %}
                                <span class="badge bg-secondary" title="{{ status }}">{{ status }}</span>
                            {% endif %}
                            </td>

                        {# --- 新增的动态列 --- #}
                        {%  if system.backup_frequency == '每季度' %}
                            <td>{{ system.last_backup_date.strftime('%Y-%m-%d') if system.last_backup_date else '无记录' }}</td>
                            <td>{{ system.next_backup_date.strftime('%Y-%m-%d') if system.next_backup_date else 'N/A' }}</td>
                            <td>
                                {% if system.next_backup_date %}
                                    {% set days_left = (system.next_backup_date - today).days %}
                                    {% if days_left < 0 %}
                                        <span class="badge bg-danger">已逾期</span>
                                    {% elif days_left <= 7 %}
                                        <span class="badge bg-warning text-dark">即将到期</span>
                                    {% else %}
                                        <span class="badge bg-success">正常</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% if current_user.role in ['admin', 'qc'] %}
                            <td>
                                <form action="{{ url_for('routes.perform_backup', system_id=system.id) }}" method="POST" onsubmit="return confirm('确认 “{{ system.name }}” 今日已完成备份吗？')">
                                    <button type="submit" class="btn btn-sm btn-success">备份完成</button>
                                </form>
                            </td>
                            {% endif %}
                        {% else %}
                            {# 如果备份频次不是时间相关的，则显示空列 #}
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            {% if current_user.role in ['admin', 'qc'] %}
                            <td>-</td>
                            {% endif %}
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr><td colspan="10" class="text-center text-muted">系统中没有任何记录。</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}