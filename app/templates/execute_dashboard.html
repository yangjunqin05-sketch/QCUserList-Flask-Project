<!-- app/templates/execute_dashboard.html -->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">远程脚本执行</h1>

    <div class="row">
        <!-- 左侧: 系统列表与执行 (HTML部分无变化) -->
        <div class="col-lg-8">
            <h4>目标系统</h4>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>系统名称</th>
                            <th>计算机名</th>
                            <th>上次任务状态</th>
                            <th>选择脚本并执行</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for system in systems %}
                        <tr>
                            <td>{{ system.name }}</td>
                            <td><code>{{ system.computer_name }}</code></td>
                            <td id="status-cell-{{ system.id }}">
                                {% set job = latest_jobs.get(system.id) %}
                                {% if job %}
                                    <span class="badge 
                                        {% if job.status == 'completed' %}bg-success
                                        {% elif job.status == 'failed' %}bg-danger
                                        {% elif job.status == 'running' %}bg-primary
                                        {% else %}bg-secondary{% endif %}">
                                        {{ job.status }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-light text-dark">无记录</span>
                                {% endif %}
                            </td>
                            <td>
                                <form onsubmit="executeScript(event, {{ system.id }}, '{{ system.computer_name }}')">
                                    <div class="input-group">
                                        <select class="form-select form-select-sm" id="script-select-{{ system.id }}" required>
                                            <option value="" selected disabled>选择一个脚本...</option>
                                            {% for script in scripts %}
                                            <option value="{{ script.id }}">{{ script.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-primary">执行</button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">没有可执行远程脚本的已注册系统。</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 右侧: 最近任务历史 (HTML部分无变化) -->
        <div class="col-lg-4">
            <h4>最近任务 (最近20条)</h4>
            <ul class="list-group">
                {% for job in recent_jobs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ job.system.computer_name }}</strong>
                        <small class="d-block text-muted">{{ job.script.name }}</small>
                    </div>
                    <div>
                        <span class="badge 
                            {% if job.status == 'completed' %}bg-success
                            {% elif job.status == 'failed' %}bg-danger
                            {% elif job.status == 'running' %}bg-primary
                            {% else %}bg-secondary{% endif %} me-2">
                            {{ job.status }}
                        </span>
                        {% if job.status == 'pending' %}
                        <form action="{{ url_for('routes.cancel_job', job_id=job.id) }}" method="POST" class="d-inline">
                             <button type="submit" class="btn btn-xs btn-outline-warning" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .25rem; --bs-btn-font-size: .7rem;"
                                     onclick="return confirm('确定要取消这个待处理的任务吗？')">
                                 取消
                             </button>
                        </form>
                        {% endif %}
                    </div>
                </li>
                {% else %}
                <li class="list-group-item text-muted">尚无任务记录。</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- 模态框 (HTML部分无变化) -->
<div class="modal fade" id="jobResultModal" tabindex="-1" aria-labelledby="jobResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="jobResultModalLabel">任务执行状态</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>目标主机:</strong> <span id="modal-hostname"></span></p>
        <p><strong>当前状态:</strong> <span id="modal-status" class="badge"></span></p>
        <hr>
        <h6>执行输出:</h6>
        <pre><code id="modal-output" class="bg-light p-2 d-block" style="white-space: pre-wrap; word-break: break-all;">等待任务开始...</code></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// --- 开始 JS 修改 ---

// 全局变量，用于存储轮询定时器和标记任务状态
let pollInterval;
let jobIsFinished = false; 

const resultModalElement = document.getElementById('jobResultModal');
const resultModal = new bootstrap.Modal(resultModalElement);

// executeScript 函数 (无变化)
function executeScript(event, systemId, hostname) {
    event.preventDefault();
    const scriptSelect = document.getElementById(`script-select-${systemId}`);
    const scriptId = scriptSelect.value;
    const statusCell = document.getElementById(`status-cell-${systemId}`);

    if (!scriptId) {
        alert('请先选择一个脚本。');
        return;
    }
    
    statusCell.innerHTML = `<span class="badge bg-warning text-dark">请求中...</span>`;

    fetch(`/api/system/${systemId}/execute_job`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script_id: scriptId }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.job_id) {
            statusCell.innerHTML = `<span class="badge bg-secondary">已创建 (pending)</span>`;
            startPolling(data.job_id, hostname);
        } else {
            statusCell.innerHTML = `<span class="badge bg-danger">创建失败</span>`;
            alert('执行失败: ' + data.message);
        }
    })
    .catch(error => {
        statusCell.innerHTML = `<span class="badge bg-danger">网络错误</span>`;
        console.error('Error:', error);
        alert('请求失败，请检查网络连接或联系管理员。');
    });
}

// startPolling 函数 (有修改)
function startPolling(jobId, hostname) {
    // 重置任务完成标记
    jobIsFinished = false;

    // 准备并显示模态框
    document.getElementById('modal-hostname').textContent = hostname;
    document.getElementById('modal-status').textContent = '待处理 (pending)';
    document.getElementById('modal-status').className = 'badge bg-secondary';
    document.getElementById('modal-output').textContent = '等待 Agent 领取任务...';
    resultModal.show();

    if (pollInterval) { clearInterval(pollInterval); }

    pollInterval = setInterval(() => {
        fetch(`/api/job/${jobId}/status`)
            .then(response => response.json())
            .then(data => {
                updateModal(data);
                // **修改点 1**: 当任务结束时，不再设置定时刷新
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval); // 仅停止轮询
                    jobIsFinished = true;        // 并标记任务已完成
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
                document.getElementById('modal-output').textContent = "轮询状态失败，请检查网络。";
                clearInterval(pollInterval);
            });
    }, 3000);
}

// updateModal 函数 (无变化)
function updateModal(data) {
    const statusSpan = document.getElementById('modal-status');
    statusSpan.textContent = data.status;

    switch (data.status) {
        case 'pending': statusSpan.className = 'badge bg-secondary'; break;
        case 'running':
            statusSpan.className = 'badge bg-primary';
            document.getElementById('modal-output').textContent = '任务正在执行中...';
            break;
        case 'completed':
            statusSpan.className = 'badge bg-success';
            document.getElementById('modal-output').textContent = data.output || '(无输出内容)';
            break;
        case 'failed':
            statusSpan.className = 'badge bg-danger';
            document.getElementById('modal-output').textContent = data.output || '(无错误详情)';
            break;
    }
}

// **修改点 2**: 监听模态框的关闭事件
resultModalElement.addEventListener('hidden.bs.modal', () => {
    // 确保轮询已停止
    if (pollInterval) { clearInterval(pollInterval); }
    
    // 只有当任务完成后关闭模态框，才刷新页面
    if (jobIsFinished) {
        window.location.reload();
    }
});

// --- 结束 JS 修改 ---
$(document).ready(function() {
    $('.modal-dialog').draggable({
        handle: ".modal-header"
    });
});
</script>
{% endblock %}