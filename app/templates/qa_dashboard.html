<!-- app/templates/qa_dashboard.html -->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">QA核查列表</h1>
    <!-- ... (筛选表单保持不变) ... -->

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>系统编号</th>
                            <th>仪器/系统名称</th>
                            <th>系统分组</th>
                            <th>上次QA核查</th>
                            <th>QA核查周期</th>
                            <th><a href="{{ url_for('routes.qa_dashboard', group=current_group_id, sort_by='qa_next_check_date') }}" class="text-decoration-none">下次QA核查 <i class="bi bi-arrow-down-up small"></i></a></th>
                            <th>状态</th>
                            {% if current_user.role == 'admin','qa'%}
                            <th>操作</th>
                            <th>是否核查</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for system in systems %}
                        <tr>
                            ...
                            {# 核心修正：admin 和 qa 都能看到操作列的内容 #}
                            {% if current_user.role in ['admin', 'qa'] %}
                            <td>
                                <div class="d-flex flex-nowrap">
                                    <form action="{{ url_for('routes.update_qa_dates', ... ) }}" ...>...</form>
                                    {% if system.needs_qa_check and (system.is_qa_due() or system.is_qa_overdue()) %}
                                    <form action="{{ url_for('routes.perform_qa_check', ... ) }}" ...>...</form>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if current_user.role == 'admin' %}
                                <form action="{{ url_for('routes.toggle_qa_check_need', ... ) }}" ...>...</form>
                                {% else %}
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" disabled {% if system.needs_qa_check %}checked{% endif %}>
                                    </div>
                                {% endif %}
                            </td>
                            {% else %}
                                {# QC组用户看到的是只读数据 #}
                                <td>{{ system.qa_last_check_date.strftime('%Y-%m-%d') if system.qa_last_check_date }}</td>
                                <td>{{ (system.qa_check_frequency_days|string + '天') if system.qa_check_frequency_days }}</td>
                                <td>{{ system.qa_next_check_date.strftime('%Y-%m-%d') if system.qa_next_check_date }}</td>
                                <td>...</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}