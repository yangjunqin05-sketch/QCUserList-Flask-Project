<!-- app/templates/qa_dashboard.html -->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">QA核查列表</h1>
    <!-- ... (筛选表单保持不变) ... -->

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>系统编号</th>
                            <th>仪器/系统名称</th>
                            <th>系统分组</th>
                            <th>上次QA核查</th>
                            <th>QA核查周期</th>
                            <th><a href="{{ url_for('routes.qa_dashboard', group=current_group_id, sort_by='qa_next_check_date') }}" class="text-decoration-none">下次QA核查 <i class="bi bi-arrow-down-up small"></i></a></th>
                            <th>状态</th>
                            {% if current_user.role == 'admin' %}
                            <th>操作</th>
                            <th>是否核查</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for system in systems %}
                        {# 根据是否需要核查，应用不同的样式 #}
                        <tr class="{{ 'table-danger' if system.needs_qa_check and system.is_qa_overdue() else ('table-warning' if system.needs_qa_check and system.is_qa_due() else ('table-secondary opacity-50' if not system.needs_qa_check else '')) }}">
                            <td>{{ system.system_number }}</td>
                            <td><a href="{{ url_for('routes.system_detail', system_id=system.id) }}">{{ system.name }}</a></td>
                            <td><span class="badge bg-secondary">{{ system.group.name if system.group else '未分组' }}</span></td>
                            
                            {% if current_user.role == 'admin' %}
                            <form action="{{ url_for('routes.update_qa_dates', system_id=system.id) }}" method="POST">
                                <td><input type="date" name="qa_last_check_date" class="form-control form-control-sm" value="{{ system.qa_last_check_date.strftime('%Y-%m-%d') if system.qa_last_check_date }}" {{ 'disabled' if not system.needs_qa_check }}></td>
                                <td>
                                    <select name="qa_check_frequency_days" class="form-select form-select-sm" {{ 'disabled' if not system.needs_qa_check }}>
                                        <option value="" {% if not system.qa_check_frequency_days %}selected{% endif %}>--周期--</option>
                                        <option value="30" {% if system.qa_check_frequency_days == 30 %}selected{% endif %}>30天</option>
                                        <option value="90" {% if system.qa_check_frequency_days == 90 %}selected{% endif %}>90天</option>
                                    </select>
                                </td>
                                <td>{{ system.qa_next_check_date.strftime('%Y-%m-%d') if system.qa_next_check_date else 'N/A' }}</td>
                                <td>
                                    {% if system.needs_qa_check and system.qa_next_check_date %}
                                        {% if system.is_qa_overdue() %}<span class="badge bg-danger">已逾期</span>
                                        {% elif system.is_qa_due() %}<span class="badge bg-warning text-dark">即将到期</span>
                                        {% else %}<span class="badge bg-success">正常</span>{% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-nowrap">
                                        <button type="submit" class="btn btn-outline-primary btn-sm me-1" {{ 'disabled' if not system.needs_qa_check }}>保存</button>
                                    </form>
                                    {% if system.needs_qa_check and (system.is_qa_due() or system.is_qa_overdue()) %}
                                    <form action="{{ url_for('routes.perform_qa_check', system_id=system.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('确认 “{{ system.name }}” 今日QA核查完成吗？')">核查完成</button>
                                    </form>
                                    {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <form action="{{ url_for('routes.toggle_qa_check_need', system_id=system.id) }}" method="POST">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" onchange="this.form.submit()" {% if system.needs_qa_check %}checked{% endif %}>
                                        </div>
                                    </form>
                                </td>
                            {% else %}
                            <!-- 普通用户只读视图 -->
                            <td>...</td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr><td colspan="9" class="text-center text-muted">系统中没有任何记录。</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}