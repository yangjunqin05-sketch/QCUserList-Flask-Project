<!-- app/templates/system_detail.html (最终完整版) -->

{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><small class="text-muted">{{ system.system_number }}</small> - {{ system.name }}</h2>
        {% if current_user.role == 'admin' %}
            <a href="{{ url_for('routes.edit_system', system_id=system.id) }}" class="btn btn-secondary"><i class="bi bi-pencil-square me-1"></i>编辑系统信息</a>
        {% endif %}
    </div>
    <hr>
    <div class="row g-4">
        <!-- 左侧列 -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="bi bi-people-fill me-2"></i>计算机化系统用户清单</h4>
                {% if current_user.role == 'admin' %}
                    <a href="{{ url_for('routes.batch_import_users', system_id=system.id) }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-upload me-1"></i>批量导入用户</a>
                {% endif %}
            </div>
            <div class="row">
                <!-- 电脑用户卡片 -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center"><strong>电脑用户清单</strong>{% if system.is_domain_joined %}<span class="badge bg-success">已加域</span>{% endif %}</div>
                        <div class="card-body">
                            {% set active_computer_users = system.system_users.filter_by(is_active=True).all() %}
                            {% if active_computer_users %}
                            <table class="table table-sm">
                                <thead><tr><th>用户名</th><th>中文名</th><th>电脑角色</th></tr></thead>
                                <tbody>
                                {% for su in active_computer_users %}
                                <tr>
                                    <td><code>{{ su.account.username }}</code></td>
                                    <td>{{ su.account.chinese_name }}</td>
                                    <td>{{ su.system_role }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-muted">该系统暂无活动电脑用户。</p>
                            {% endif %}
                            
                            {% set disabled_computer_users = system.system_users.filter_by(is_active=False).all() %}
                            {% if disabled_computer_users %}
                            <hr>
                            <h6 class="text-muted small">已禁用用户</h6>
                            <ul class="list-group list-group-flush">
                                {% for su in disabled_computer_users %}
                                <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary py-1 px-2">
                                    <small><code>{{ su.account.username }}</code> ({{ su.account.chinese_name }}) - {{ su.system_role }}</small>
                                    <form action="{{ url_for('routes.enable_user_link', link_type='computer', link_id=su.id) }}" method="POST" onsubmit="return confirm('确认要重新启用该用户的此项权限吗？')">
                                        <button class="btn btn-outline-success btn-sm" style="--bs-btn-padding-y: .1rem; font-size: 0.75rem;">启用</button>
                                    </form>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% if current_user.role == 'admin' %}
                        <div class="card-footer">
                            <a class="text-decoration-none" data-bs-toggle="collapse" href="#addComputerUserForm" role="button">
                                <h6 class="card-title small"><i class="bi bi-plus-circle me-1"></i>添加电脑用户</h6>
                            </a>
                            <div class="collapse" id="addComputerUserForm">
                                <form action="" method="post" novalidate class="mt-2">
                                    {{ add_sys_user_form.hidden_tag() }}
                                    <div class="mb-2">{{ add_sys_user_form.username(class="form-control form-control-sm", placeholder="用户名") }}</div>
                                    <div class="mb-2">{{ add_sys_user_form.chinese_name(class="form-control form-control-sm", placeholder="中文名") }}</div>
                                    <div class="mb-2">{{ add_sys_user_form.system_role(class="form-control form-control-sm", placeholder="电脑角色/权限") }}</div>
                                    {{ add_sys_user_form.submit_computer(class="btn btn-secondary btn-sm") }}
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 工作站用户卡片 -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center"><strong>工作站用户清单</strong>{% if system.is_workstation_domain_joined %}<span class="badge bg-success">已加域</span>{% endif %}</div>
                        <div class="card-body">
                             {% set active_ws_users = system.workstation_users.filter_by(is_active=True).all() %}
                             {% if active_ws_users %}
                             <table class="table table-sm">
                                <thead><tr><th>用户名</th><th>中文名</th><th>工作站角色</th></tr></thead>
                                <tbody>
                                {% for wu in active_ws_users %}
                                <tr>
                                    <td><code>{{ wu.account.username }}</code></td>
                                    <td>{{ wu.account.chinese_name }}</td>
                                    <td>{{ wu.role.name }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-muted">该系统暂无活动工作站用户。</p>
                            {% endif %}

                            {% set disabled_ws_users = system.workstation_users.filter_by(is_active=False).all() %}
                            {% if disabled_ws_users %}
                            <hr>
                            <h6 class="text-muted small">已禁用用户</h6>
                            <ul class="list-group list-group-flush">
                                {% for wu in disabled_ws_users %}
                                <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary py-1 px-2">
                                    <small><code>{{ wu.account.username }}</code> ({{ wu.account.chinese_name }}) - {{ wu.role.name }}</small>
                                    <form action="{{ url_for('routes.enable_user_link', link_type='workstation', link_id=wu.id) }}" method="POST" onsubmit="return confirm('确认要重新启用该用户的此项权限吗？')">
                                        <button class="btn btn-outline-success btn-sm" style="--bs-btn-padding-y: .1rem; font-size: 0.75rem;">启用</button>
                                    </form>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% if current_user.role == 'admin' %}
                        <div class="card-footer">
                            <a class="text-decoration-none" data-bs-toggle="collapse" href="#addWorkstationUserForm" role="button">
                                <h6 class="card-title small"><i class="bi bi-plus-circle me-1"></i>添加工作站用户</h6>
                            </a>
                            <div class="collapse" id="addWorkstationUserForm">
                                <form action="" method="post" novalidate class="mt-2">
                                    {{ add_ws_user_form.hidden_tag() }}
                                    <div class="mb-2">{{ add_ws_user_form.username(class="form-control form-control-sm", placeholder="用户名") }}</div>
                                    <div class="mb-2">{{ add_ws_user_form.chinese_name(class="form-control form-control-sm", placeholder="中文名") }}</div>
                                    <div class="mb-2">{{ add_ws_user_form.role(class="form-control form-control-sm", placeholder="工作站角色") }}</div>
                                    {{ add_ws_user_form.submit_workstation(class="btn btn-secondary btn-sm") }}
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div> <!-- End of user lists row -->

            <!-- 远程操作卡片 -->
            {% if current_user.role == 'admin' and system.computer_name %}
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-terminal me-2"></i>远程操作</h5>
                    <p class="card-text small text-muted">选择一个脚本在此计算机 ({{ system.computer_name }}) 上执行。</p>
                    <form onsubmit="executeScript(event, {{ system.id }}, '{{ system.computer_name }}')">
                        <div class="input-group">
                            <select class="form-select" id="script-select-{{ system.id }}" required>
                                <option value="" selected disabled>-- 请选择一个脚本 --</option>
                                {% for script in scripts %}
                                <option value="{{ script.id }}">{{ script.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-play-fill me-1"></i>立即执行
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div> <!-- End of col-lg-8 (左侧列) -->

        <!-- 右侧列 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-info-circle-fill me-2"></i>系统信息</h4>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>分组:</strong> {{ system.group.name if system.group else '未分组' }}</li>
                    <li class="list-group-item"><strong>计算机名:</strong> {{ system.computer_name or 'N/A' }}</li>
                    <li class="list-group-item"><strong>IP 地址:</strong> {{ system.ip_address or 'N/A' }}</li>
                    <li class="list-group-item"><strong>备注:</strong> {{ system.notes or '无' }}</li>
                </ul>
            </div>
        </div> <!-- End of col-lg-4 (右侧列) -->
    </div> <!-- End of main row g-4 -->
</div>

<!-- 远程执行结果模态框 -->
<div class="modal fade" id="jobResultModal" tabindex="-1" aria-labelledby="jobResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="jobResultModalLabel">任务执行状态</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>目标主机:</strong> <span id="modal-hostname"></span></p>
        <p><strong>当前状态:</strong> <span id="modal-status" class="badge"></span></p>
        <hr>
        <h6>执行输出:</h6>
        <pre><code id="modal-output" class="bg-light p-2 d-block" style="white-space: pre-wrap; word-break: break-all;">等待任务开始...</code></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pollInterval;
let jobIsFinished = false; 

const resultModalElement = document.getElementById('jobResultModal');
const resultModal = new bootstrap.Modal(resultModalElement);

function executeScript(event, systemId, hostname) {
    event.preventDefault();
    const scriptSelect = document.getElementById(`script-select-${systemId}`);
    const scriptId = scriptSelect.value;
    if (!scriptId) {
        alert('请先选择一个要执行的脚本。');
        return;
    }
    fetch(`/api/system/${systemId}/execute_job`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script_id: scriptId }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.job_id) {
            startPolling(data.job_id, hostname);
        } else {
            alert('执行失败: ' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('请求失败，请检查网络连接。');
    });
}

function startPolling(jobId, hostname) {
    jobIsFinished = false;
    document.getElementById('modal-hostname').textContent = hostname;
    document.getElementById('modal-status').textContent = '待处理 (pending)';
    document.getElementById('modal-status').className = 'badge bg-secondary';
    document.getElementById('modal-output').textContent = '等待 Agent 领取任务...';
    resultModal.show();
    if (pollInterval) { clearInterval(pollInterval); }
    pollInterval = setInterval(() => {
        fetch(`/api/job/${jobId}/status`)
            .then(response => response.json())
            .then(data => {
                updateModal(data);
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval);
                    jobIsFinished = true;
                }
            });
    }, 3000);
}

function updateModal(data) {
    const statusSpan = document.getElementById('modal-status');
    statusSpan.textContent = data.status;
    switch (data.status) {
        case 'pending': statusSpan.className = 'badge bg-secondary'; break;
        case 'running':
            statusSpan.className = 'badge bg-primary';
            document.getElementById('modal-output').textContent = '任务正在执行中...';
            break;
        case 'completed':
            statusSpan.className = 'badge bg-success';
            document.getElementById('modal-output').textContent = data.output || '(无输出内容)';
            break;
        case 'failed':
            statusSpan.className = 'badge bg-danger';
            document.getElementById('modal-output').textContent = data.output || '(无错误详情)';
            break;
    }
}

resultModalElement.addEventListener('hidden.bs.modal', () => {
    if (pollInterval) { clearInterval(pollInterval); }
});

</script>
{% endblock %}