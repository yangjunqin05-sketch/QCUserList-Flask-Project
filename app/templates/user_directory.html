<!-- app/templates/user_directory.html (添加部分删除功能版) -->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-1">全系统用户目录</h1>
            <p class="text-muted mb-0">
                此页面按中文名汇总了所有系统账户及其权限。
            </p>
        </div>
    </div>

    <!-- 搜索框 -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('routes.user_directory') }}">
                <div class="input-group">
                    <input type="search" name="search" class="form-control" placeholder="按用户名或中文名搜索..." value="{{ search_term or '' }}">
                    <button class="btn btn-secondary" type="submit"><i class="bi bi-search"></i> 搜索</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 15%;">中文名</th>
                            <th scope="col" style="width: 15%;">用户名</th>
                            <th scope="col" style="width: 55%;">所在系统及角色</th>
                            {% if current_user.role == 'admin' %}
                            <th scope="col" style="width: 15%;">操作</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for chinese_name, accounts in accounts_by_person.items() %}
                        <tr>
                            <td rowspan="{{ accounts|length }}" style="vertical-align: middle;">
                                <strong>{{ chinese_name }}</strong>
                            </td>
                            
                            <td><code>{{ accounts[0].username }}</code></td>
                            <td>
                                {% set systems_map = {} %}
                                {% for su in accounts[0].system_access %}{% if su.system.name not in systems_map %}{% set _ = systems_map.update({su.system.name: {'computer': [], 'workstation': []}}) %}{% endif %}{% set _ = systems_map[su.system.name]['computer'].append(su.system_role) %}{% endfor %}
                                {% for wu in accounts[0].workstation_access %}{% if wu.system.name not in systems_map %}{% set _ = systems_map.update({wu.system.name: {'computer': [], 'workstation': []}}) %}{% endif %}{% set _ = systems_map[wu.system.name]['workstation'].append(wu.role.name) %}{% endfor %}
                                <ul class="list-unstyled mb-0 small">
                                    {% for system_name, roles in systems_map.items() %}
                                    <li><strong>{{ system_name }}:</strong> {% if roles.computer %}电脑用户 ({{ roles.computer | join(', ') }}){% endif %}{% if roles.computer and roles.workstation %}; {% endif %}{% if roles.workstation %}工作站用户 ({{ roles.workstation | join(', ') }}){% endif %}</li>
                                    {% endfor %}
                                </ul>
                            </td>

                            {% if current_user.role == 'admin' %}
                            <td rowspan="{{ accounts|length }}" style="vertical-align: middle;">
                                <!-- 修改按钮文字和路由 -->
                                <form action="{{ url_for('routes.request_person_disable', chinese_name=chinese_name) }}" method="POST" onsubmit="return confirm('警告：确定要为 “{{ chinese_name }}” 的所有活动账户申请禁用吗？')" class="d-inline">
                                    <button type="submit" class="btn btn-danger btn-sm">申请禁用</button>
                                </form>
                                <button type="button" class="btn btn-warning btn-sm d-inline ms-1" onclick="openPartialDisableModal('{{ chinese_name }}')">
                                    部分禁用
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        
                        {% for account in accounts[1:] %}
                        <tr>
                            <td><code>{{ account.username }}</code></td>
                            <td>
                                {% set systems_map = {} %}
                                {% for su in account.system_access %}{% if su.system.name not in systems_map %}{% set _ = systems_map.update({su.system.name: {'computer': [], 'workstation': []}}) %}{% endif %}{% set _ = systems_map[su.system.name]['computer'].append(su.system_role) %}{% endfor %}
                                {% for wu in account.workstation_access %}{% if wu.system.name not in systems_map %}{% set _ = systems_map.update({wu.system.name: {'computer': [], 'workstation': []}}) %}{% endif %}{% set _ = systems_map[wu.system.name]['workstation'].append(wu.role.name) %}{% endfor %}
                                <ul class="list-unstyled mb-0 small">
                                    {% for system_name, roles in systems_map.items() %}
                                    <li><strong>{{ system_name }}:</strong> {% if roles.computer %}电脑用户 ({{ roles.computer | join(', ') }}){% endif %}{% if roles.computer and roles.workstation %}; {% endif %}{% if roles.workstation %}工作站用户 ({{ roles.workstation | join(', ') }}){% endif %}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                        {% endfor %}

                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">{% if search_term %}没有找到符合“{{ search_term }}”的用户。{% else %}当前没有任何系统用户被记录。{% endif %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 新增：部分删除模态框 -->
<div class="modal fade" id="partialDeleteModal" tabindex="-1" aria-labelledby="partialDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="partialDisableModalLabel">为用户 <span id="modal-user-name"></span> 申请部分权限禁用</h5>
        ...
      </div>
      <form id="modal-form" method="POST">
          <div class="modal-body">
            <p class="text-muted">请勾选需要禁用的权限：</p>
            <div id="modal-body-content">
                <!-- JavaScript会在这里动态填充复选框 -->
                <div class="text-center my-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">正在加载...</span>
                    </div>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary">提交申请</button>
          </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- 之前的联动删除JS保持不变 -->
<script>
    async function confirmSmartDeletion(event, chineseName) { /* ... 此函数代码保持不变 ... */ }
</script>

<!-- 新增：处理部分删除模态框的JS -->
<script>
const partialDeleteModalEl = document.getElementById('partialDeleteModal');
const partialDeleteModal = new bootstrap.Modal(partialDeleteModalEl);
const modalUserName = document.getElementById('modal-user-name');
const modalBodyContent = document.getElementById('modal-body-content');
const modalForm = document.getElementById('modal-form');

async function openPartialDisableModal(chineseName)  {
    // 1. 重置并显示模态框
    modalUserName.textContent = chineseName;
    modalBodyContent.innerHTML = `<div class="text-center my-3"><div class="spinner-border" role="status"></div></div>`;
    modalForm.action = `/user/request_partial_disable/${encodeURIComponent(chinese_name)}`;
    partialDeleteModal.show();

    // 2. 异步获取该用户的所有权限
    try {
        const response = await fetch(`/api/user/${encodeURIComponent(chineseName)}/access_links`);
        if (!response.ok) throw new Error('网络响应错误');
        const data = await response.json();

        // 3. 动态构建复选框列表
        let content = '<p class="text-muted">该用户没有可供删除的权限。</p>';
        if (data.computer_links.length > 0 || data.workstation_links.length > 0) {
            content = '';
            if (data.computer_links.length > 0) {
                content += '<fieldset class="mb-3"><legend class="h6">电脑用户权限</legend>';
                data.computer_links.forEach(link => {
                    content += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="computer_links" value="${link.id}" id="comp-link-${link.id}">
                            <label class="form-check-label" for="comp-link-${link.id}">
                                <strong>${link.system_name}:</strong> ${link.role}
                            </label>
                        </div>
                    `;
                });
                content += '</fieldset>';
            }
            if (data.workstation_links.length > 0) {
                content += '<fieldset><legend class="h6">工作站用户权限</legend>';
                data.workstation_links.forEach(link => {
                    content += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="workstation_links" value="${link.id}" id="ws-link-${link.id}">
                            <label class="form-check-label" for="ws-link-${link.id}">
                                <strong>${link.system_name}:</strong> ${link.role}
                            </label>
                        </div>
                    `;
                });
                content += '</fieldset>';
            }
        }
        modalBodyContent.innerHTML = content;
    } catch (error) {
        console.error("加载权限失败:", error);
        modalBodyContent.innerHTML = '<p class="text-danger">加载用户权限列表失败，请稍后重试。</p>';
    }
}
</script>
{% endblock %}