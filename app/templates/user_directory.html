<!-- app/templates/user_directory.html (最终功能修复版) -->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-1">全系统用户目录</h1>
            <p class="text-muted mb-0">
                此页面按中文名汇总了所有有效的系统账户及其权限。
            </p>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-body">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                     <input type="search" id="user-search-input" class="form-control" placeholder="按用户名或中文名实时搜索..." value="{{ search_term or '' }}">
                </div>
            </form>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 15%;">中文名</th>
                            <th scope="col" style="width: 15%;">用户名</th>
                            <th scope="col" style="width: 55%;">所在系统及角色 (仅显示活动权限)</th>
                            {% if current_user.role in ['admin', 'qc'] %}
                            <th scope="col" style="width: 15%;">操作</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="user-directory-body">
                        {% for chinese_name, accounts in accounts_by_person.items() %}
                        <tr>
                            <td rowspan="{{ accounts|length }}" style="vertical-align: middle;"><strong>{{ chinese_name }}</strong></td>
                            <td><code>{{ accounts[0].username }}</code></td>
                            <td>
                                {# --- 核心修正：构建包含编号的 systems_map --- #}
                                {% set systems_map = {} %}
                                {% for su in accounts[0].system_access.filter_by(is_active=True) %}
                                    {% if su.system.name not in systems_map %}{% set _ = systems_map.update({su.system.name: {'number': su.system.system_number, 'computer': [], 'workstation': []}}) %}{% endif %}
                                    {% set _ = systems_map[su.system.name]['computer'].append(su.system_role) %}
                                {% endfor %}
                                {% for wu in accounts[0].workstation_access.filter_by(is_active=True) %}
                                    {% if wu.system.name not in systems_map %}{% set _ = systems_map.update({wu.system.name: {'number': wu.system.system_number, 'computer': [], 'workstation': []}}) %}{% endif %}
                                    {% set _ = systems_map[wu.system.name]['workstation'].append(wu.role.name) %}
                                {% endfor %}
                                <ul class="list-unstyled mb-0 small">
                                    {# --- 核心修正：渲染时使用 data.number --- #}
                                    {% for system_name, data in systems_map.items() %}
                                    <li>
                                        <strong>{{ data.number }} - {{ system_name }}:</strong> 
                                        {% if data.computer %}电脑用户 ({{ data.computer | join(', ') }}){% endif %}
                                        {% if data.computer and data.workstation %}; {% endif %}
                                        {% if data.workstation %}工作站用户 ({{ data.workstation | join(', ') }}){% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </td>
                            {% if current_user.role in ['admin', 'qc'] %}
                            <td rowspan="{{ accounts|length }}" style="vertical-align: middle;">
                                <form action="{{ url_for('routes.request_person_disable', chinese_name=chinese_name) }}" method="POST" 
                                      onsubmit="confirmFullDisable(event, '{{ chinese_name }}')" class="d-inline">
                                    <button type="submit" class="btn btn-danger btn-sm">全部禁用</button>
                                </form>
                                <button type="button" class="btn btn-warning btn-sm d-inline ms-1" onclick="openPartialDisableModal('{{ chinese_name }}')">部分禁用</button>
                            </td>
                            {% endif %}
                        </tr>
                        {% for account in accounts[1:] %}
                        <tr>
                            <td><code>{{ account.username }}</code></td>
                            <td>
                                {% set systems_map = {} %}
                                {% for su in account.system_access.filter_by(is_active=True) %}{% if su.system.name not in systems_map %}{% set _ = systems_map.update({su.system.name: {'computer': [], 'workstation': []}}) %}{% endif %}{% set _ = systems_map[su.system.name]['computer'].append(su.system_role) %}{% endfor %}
                                {% for wu in account.workstation_access.filter_by(is_active=True) %}{% if wu.system.name not in systems_map %}{% set _ = systems_map.update({wu.system.name: {'computer': [], 'workstation': []}}) %}{% endif %}{% set _ = systems_map[wu.system.name]['workstation'].append(wu.role.name) %}{% endfor %}
                                <ul class="list-unstyled mb-0 small">
                                    {% for system_name, roles in systems_map.items() %}
                                    <li><strong>{{ system_name }}:</strong> {% if roles.computer %}电脑用户 ({{ roles.computer | join(', ') }}){% endif %}{% if roles.computer and roles.workstation %}; {% endif %}{% if roles.workstation %}工作站用户 ({{ roles.workstation | join(', ') }}){% endif %}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted">{% if search_term %}没有找到符合“{{ search_term }}”的用户。{% else %}当前没有任何有效的系统用户被记录。{% endif %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 部分禁用模态框 -->
<div class="modal fade" id="partialDisableModal" tabindex="-1" aria-labelledby="partialDisableModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="partialDisableModalLabel">为用户 <span id="modal-user-name" class="fw-bold"></span> 申请部分权限禁用</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="modal-form" method="POST">
          <div class="modal-body">
            <p class="text-muted">请勾选需要禁用的权限，勾选系统名称可全选该系统下的所有权限。</p>
            <div id="modal-body-content">
                <div class="text-center my-3"><div class="spinner-border" role="status"><span class="visually-hidden">正在加载...</span></div></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary">提交申请</button>
          </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- 核心修正：确保两个主要功能函数都存在 -->
<script>

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('user-search-input');
    const tableBody = document.getElementById('user-directory-body');
    const userRole = "{{ current_user.role }}"; // 将用户角色注入JS

    // 节流函数，防止过于频繁的API请求
    function throttle(func, delay) {
        let timeout = null;
        return function(...args) {
            if (!timeout) {
                timeout = setTimeout(() => {
                    func.apply(this, args);
                    timeout = null;
                }, delay);
            }
        };
    }

    // 获取并渲染用户数据的主函数
    async function fetchUsers() {
        const searchTerm = searchInput.value;
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">正在加载...</td></tr>`;

        try {
            const response = await fetch(`{{ url_for('routes.api_get_system_accounts') }}?search=${encodeURIComponent(searchTerm)}`);
            if (!response.ok) throw new Error('网络请求失败');
            const data = await response.json();
            
            tableBody.innerHTML = '';
            if (data.length === 0) {
                const message = searchTerm ? `没有找到符合“${searchTerm}”的用户。` : '当前没有任何有效的系统用户被记录。';
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">${message}</td></tr>`;
                return;
            }

            data.forEach(person => {
                const numAccounts = person.accounts.length;
                let rowsHtml = '';

                // 渲染第一个账号
                const firstAccount = person.accounts[0];
                let systemsHtml = '<ul class="list-unstyled mb-0 small">';
                for (const [systemName, roles] of Object.entries(firstAccount.systems)) {
                    systemsHtml += `<li><strong>${systemName}:</strong> `;
                    if (roles.computer.length > 0) systemsHtml += `电脑用户 (${roles.computer.join(', ')})`;
                    if (roles.computer.length > 0 && roles.workstation.length > 0) systemsHtml += '; ';
                    if (roles.workstation.length > 0) systemsHtml += `工作站用户 (${roles.workstation.join(', ')})`;
                    systemsHtml += '</li>';
                }
                systemsHtml += '</ul>';

                let actionButtons = '';
                if (userRole === 'admin' || userRole === 'qc') {
                    actionButtons = `
                        <td rowspan="${numAccounts}" style="vertical-align: middle;">
                            <form action="/user_requests/disable_person/${person.chinese_name}" method="POST" onsubmit="return confirm('...')" class="d-inline">
                                <button type="submit" class="btn btn-danger btn-sm">全部禁用</button>
                            </form>
                            <button type="button" class="btn btn-warning btn-sm d-inline ms-1" onclick="openPartialDisableModal('${person.chinese_name}')">部分禁用</button>
                        </td>
                    `;
                }

                rowsHtml += `
                    <tr>
                        <td rowspan="${numAccounts}" style="vertical-align: middle;"><strong>${person.chinese_name}</strong></td>
                        <td><code>${firstAccount.username}</code></td>
                        <td>${systemsHtml}</td>
                        ${actionButtons}
                    </tr>
                `;

                // 渲染剩余的账号
                for (let i = 1; i < numAccounts; i++) {
                    const account = person.accounts[i];
                    let otherSystemsHtml = '<ul class="list-unstyled mb-0 small">';
                    // ... (构建其他账号的权限显示) ...
                    otherSystemsHtml += '</ul>';
                    rowsHtml += `<tr><td><code>${account.username}</code></td><td>${otherSystemsHtml}</td></tr>`;
                }
                
                tableBody.insertAdjacentHTML('beforeend', rowsHtml);
            });

        } catch (error) {
            console.error('获取用户目录失败:', error);
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">加载数据失败，请检查网络或联系管理员。</td></tr>`;
        }
    }

    // 绑定事件
    searchInput.addEventListener('input', throttle(fetchUsers, 400)); // 400ms延迟

    // 初始加载
    fetchUsers();
});


// 函数1: “全部禁用”按钮的联动门禁功能
async function confirmFullDisable(event, chineseName) {
    event.preventDefault(); 
    const form = event.target;
    const disableSystemAccess = confirm(`警告：确定要为 “${chineseName}” 的所有活动账户申请【禁用】吗？`);
    if (!disableSystemAccess) {
        return;
    }
    const syncMenjin = confirm(`是否需要为 “${chineseName}” 同步处理【门禁权限】？\n\n- 点击 [确定] 将在提交后，跳转到门禁页面。\n- 点击 [取消] 将仅提交系统权限的禁用申请。`);
    if (syncMenjin) {
        try {
            const response = await fetch(form.action, { method: form.method });
            if (response.ok) {
                const menjinUrl = new URL("{{ url_for('menjin.list_users_page', _external=True) }}");
                menjinUrl.searchParams.set('search_name', chineseName);
                window.location.href = menjinUrl.toString();
            } else {
                alert('提交系统禁用申请时出错，请刷新页面后重试。');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('提交申请时发生网络错误。');
        }
    } else {
        form.submit();
    }
}

// 函数2: “部分禁用”按钮的弹窗功能
async function openPartialDisableModal(chineseName) {
    const modalElement = document.getElementById('partialDisableModal');
    if (!modalElement) {
        console.error('错误：找不到 ID 为 "partialDisableModal" 的模态框元素！');
        return;
    }
    const partialDisableModal = bootstrap.Modal.getOrCreateInstance(modalElement);
    const modalUserName = document.getElementById('modal-user-name');
    const modalBodyContent = document.getElementById('modal-body-content');
    const modalForm = document.getElementById('modal-form');

    modalUserName.textContent = chineseName;
    modalBodyContent.innerHTML = `<div class="text-center my-3"><div class="spinner-border" role="status"><span class="visually-hidden">正在加载...</span></div></div>`;
    modalForm.action = `/user/request_partial_disable/${encodeURIComponent(chineseName)}`;
    partialDisableModal.show();
    
    try {
        const response = await fetch(`/api/user/${encodeURIComponent(chineseName)}/access_links`);
        if (!response.ok) throw new Error('网络响应错误');
        const data = await response.json();
        
        const systemsMap = {};
        data.computer_links.forEach(link => {
            if (!systemsMap[link.system_name]) systemsMap[link.system_name] = { computer: [], workstation: [] };
            systemsMap[link.system_name].computer.push(link);
        });
        data.workstation_links.forEach(link => {
            if (!systemsMap[link.system_name]) systemsMap[link.system_name] = { computer: [], workstation: [] };
            systemsMap[link.system_name].workstation.push(link);
        });
        const systemNames = Object.keys(systemsMap);
        let content = '<p class="text-muted">该用户没有可供禁用的活动权限。</p>';
        if (systemNames.length > 0) {
            content = '';
            systemNames.forEach((systemName, index) => {
                const systemLinks = systemsMap[systemName];
                const safeSystemNameClass = systemName.replace(/[^a-zA-Z0-9]/g, '-');
                content += `<fieldset class="mb-3 border p-2 rounded"><legend class="h6"><div class="form-check"><input class="form-check-input" type="checkbox" id="system-master-check-${index}" onchange="toggleSystemChecks('${safeSystemNameClass}', this.checked)"><label class="form-check-label fw-bold" for="system-master-check-${index}">${systemName}</label></div></legend>`;
                if (systemLinks.computer.length > 0) {
                    content += '<div class="ms-4">';
                    systemLinks.computer.forEach(link => {
                        content += `<div class="form-check"><input class="form-check-input system-check-${safeSystemNameClass}" type="checkbox" name="computer_links" value="${link.id}" id="comp-link-${link.id}"><label class="form-check-label" for="comp-link-${link.id}"><span class="badge bg-info text-dark me-1">电脑用户</span> ${link.role}</label></div>`;
                    });
                    content += '</div>';
                }
                if (systemLinks.workstation.length > 0) {
                    content += '<div class="ms-4 mt-1">';
                    systemLinks.workstation.forEach(link => {
                        content += `<div class="form-check"><input class="form-check-input system-check-${safeSystemNameClass}" type="checkbox" name="workstation_links" value="${link.id}" id="ws-link-${link.id}"><label class="form-check-label" for="ws-link-${link.id}"><span class="badge bg-primary me-1">工作站</span> ${link.role}</label></div>`;
                    });
                    content += '</div>';
                }
                content += `</fieldset>`;
            });
        }
        modalBodyContent.innerHTML = content;
    } catch (error) {
        console.error("加载权限失败:", error);
        modalBodyContent.innerHTML = '<p class="text-danger">加载用户权限列表失败，请稍后重试。</p>';
    }
}

// 函数3: “部分禁用”的联动勾选辅助函数
function toggleSystemChecks(systemName, isChecked) {
    const checkboxes = document.querySelectorAll(`.system-check-${systemName}`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
}
</script>
{% endblock %}