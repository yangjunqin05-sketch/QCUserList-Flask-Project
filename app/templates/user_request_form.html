<!-- app/templates/user_request_form.html (修复JS联动失效版) -->

{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <h2 class="mb-4">系统用户新增申请</h2>
        <div class="card">
            <div class="card-body">
                <form action="" method="post" novalidate>
                    {{ form.hidden_tag() }}
                    <fieldset class="mb-4">
                        <legend class="h5">1. 填写新用户信息</legend>
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.username.label(class="form-label") }}
                                {{ form.username(class="form-control", autocomplete="off") }}
                                {% if form.username.errors %}<div class="invalid-feedback d-block">{% for error in form.username.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.chinese_name.label(class="form-label") }}
                                {{ form.chinese_name(class="form-control", autocomplete="off") }}
                                {% if form.chinese_name.errors %}<div class="invalid-feedback d-block">{% for error in form.chinese_name.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.computer_role.label(class="form-label") }}
                                {{ form.computer_role(class="form-control", list="computer-roles-list", autocomplete="off") }}
                                <datalist id="computer-roles-list"></datalist>
                            </div>
                            <div class="col-md-6">
                                {{ form.workstation_role.label(class="form-label") }}
                                {{ form.workstation_role(class="form-control", list="workstation-roles-list", autocomplete="off") }}
                                <datalist id="workstation-roles-list"></datalist>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="mb-4">
                        <legend class="h5">2. 选择目标系统</legend>
                        <div class="mb-3">
                            <select id="group-filter-select" class="form-select">
                                <option value="all" selected>-- 按系统分组筛选 --</option>
                                <option value="none">未分组</option>
                                {% for group in all_groups %}<option value="{{ group.name }}">{{ group.name }}</option>{% endfor %}
                            </select>
                        </div>
                        {{ form.target_system(class="form-select") }}
                        {% if form.target_system.errors %}<div class="invalid-feedback d-block">{% for error in form.target_system.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                    </fieldset>
                    <fieldset>
                        <legend class="h5">3. (参考) 已选系统当前工作站用户</legend>
                        <div id="existing-users-display" class="bg-light p-3 rounded small">
                            <p class="text-muted">请先选择上面的系统以查看其当前用户。</p>
                        </div>
                    </fieldset>
                    <div class="mt-4">{{ form.submit(class="btn btn-primary btn-lg", value="提交申请") }}</div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const allSystems = {{ systems_with_groups|tojson|safe }};

document.addEventListener('DOMContentLoaded', function () {
    const groupSelect = document.getElementById('group-filter-select');
    const systemSelect = document.getElementById('target_system');
    const displayDiv = document.getElementById('existing-users-display');
    const computerRolesDatalist = document.getElementById('computer-roles-list');
    const workstationRolesDatalist = document.getElementById('workstation-roles-list');

    // 系统分组筛选逻辑
    groupSelect.addEventListener('change', function() {
        const selectedGroup = this.value;
        const filteredSystems = allSystems.filter(system => {
            if (selectedGroup === 'all') return true;
            if (selectedGroup === 'none') return system.group === 'none'; // 'none' 是我们在后端定义的特殊值
            return system.group === selectedGroup;
        });
        
        let optionsHtml = '<option value="0">-- 请选择一个系统 --</option>';
        filteredSystems.forEach(system => {
            optionsHtml += `<option value="${system.id}">${system.name}</option>`;
        });
        systemSelect.innerHTML = optionsHtml;
        
        // 核心修正：在更新完系统列表后，手动触发一次 change 事件
        // 这会告诉下面的 systemSelect.addEventListener 去执行它的逻辑
        systemSelect.dispatchEvent(new Event('change'));
    });

    // 目标系统选择后触发的逻辑
    systemSelect.addEventListener('change', function() {
        const systemId = this.value;
        
        // 每次选择都先清空旧数据
        displayDiv.innerHTML = '<p class="text-muted">请先选择上面的系统以查看其当前用户。</p>';
        computerRolesDatalist.innerHTML = '';
        workstationRolesDatalist.innerHTML = '';

        if (!systemId || systemId === '0') {
            return; // 如果选择的是 "-- 请选择 --"，则不执行后续API调用
        }

        // 1. 获取参考用户列表
        displayDiv.innerHTML = '<p class="text-muted">正在加载用户...</p>';
        fetch(`/api/system/${systemId}/users`)
            .then(res => res.json())
            .then(users => {
                let html = '';
                if (users && users.length > 0) {
                    html += '<ul class="mb-0">';
                    users.forEach(user => { html += `<li>${user.name} (${user.role})</li>`; });
                    html += '</ul>';
                } else {
                    html += '<p class="mb-0 text-muted">(该系统暂无工作站用户)</p>';
                }
                displayDiv.innerHTML = html;
            }).catch(error => {
                console.error("加载参考用户失败:", error);
                displayDiv.innerHTML = '<p class="text-danger">加载用户列表失败。</p>';
            });

        // 2. 获取角色智能推荐
        fetch(`/api/system/${systemId}/roles`)
            .then(response => response.json())
            .then(data => {
                let computerOptions = '';
                if (data.computer_roles) {
                    data.computer_roles.forEach(role => {
                        computerOptions += `<option value="${role}"></option>`;
                    });
                }
                computerRolesDatalist.innerHTML = computerOptions;

                let workstationOptions = '';
                if (data.workstation_roles) {
                    data.workstation_roles.forEach(role => {
                        workstationOptions += `<option value="${role}"></option>`;
                    });
                }
                workstationRolesDatalist.innerHTML = workstationOptions;
            })
            .catch(error => console.error('加载角色推荐失败:', error));
    });
});
</script>
{% endblock %}